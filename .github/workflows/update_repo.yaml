# PERSONAL_TOKEN

name: Download Artifact and Commit
env:
  REPO_BD_NAME: me.hexor.ru
on:
  repository_dispatch:
    types: [new_artifact]
  push:
    branches:
      - main

jobs:
  download-and-commit:
    runs-on: ubuntu-latest
    container:
      image: archlinux
    strategy:
      matrix:
        repo: ['house-of-vanity/rexec_x86_64-linux-musl']
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Install jq
      run: |
        pacman -Sy
        pacman -S --noconfirm jq
    - name: Download artifacts
      run: |
        REPO_NAME=$(echo "${{ matrix.repo }}" | cut -d '/' -f1)
        ARTIFACT_NAME=$(echo "${{ matrix.repo }}" | cut -d'/' -f2)
        ARTIFACT_ID=$(curl -H "Authorization: token ${{ secrets.PERSONAL_TOKEN }}" https://api.github.com/repos/$REPO_NAME/actions/artifacts | jq '.artifacts[] | select(.name=="'$ARTIFACT_NAME'") | .id')
      run: |
        curl -L -o x86_64/$ARTIFACT_NAME.zip -H "Authorization: token ${{ secrets.PERSONAL_TOKEN }}" https://api.github.com/repos/$REPO_NAME/actions/artifacts/$ARTIFACT_ID/zip

    - name: Perform actions
      run: |
        repo-add  $REPO_BD_NAME.db.tar.gz *.zst  -s
    - name: Commit and push
      run: |
        git config --local user.email "repo_master@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "Update from artifact"
        git push

